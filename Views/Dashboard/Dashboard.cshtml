@model AIStockRadar.ViewModels.DashboardViewModel
@using System.Text.Json

@{
    ViewData["Title"] = "Dashboard";
    var labelsJson = JsonSerializer.Serialize(Model.ProfitLabels ?? new List<string>());
    var valuesJson = JsonSerializer.Serialize(Model.ProfitValues ?? new List<decimal>());
}

<!-- Top center: Radar button -->
<div class="d-flex justify-content-center mt-3">
    <a asp-controller="AI" asp-action="Index" class="btn btn-success btn-lg px-5">Radar</a>
</div>

<!-- Middle layout -->
<div class="container mt-4">
    <div class="row g-3">
        <!-- Left: Scrollable holdings (ticker only) + Buy/Sell -->
        <div class="col-lg-5 col-md-6">
            <div class="card shadow-sm">
                <div class="card-header">
                    <strong>Your Holdings</strong>
                </div>

                <div class="card-body" style="max-height: 420px; overflow-y: auto;">
                    @if (Model.Holdings == null || Model.Holdings.Count == 0)
                    {
                        <div class="text-muted">No open holdings.</div>
                    }
                    else
                    {
                        <ul class="list-group list-group-flush">
                            @foreach (var h in Model.Holdings)
                            {
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div class="fw-semibold">
                                        @(h.Security?.Ticker ?? $"#{h.SecurityId}")
                                    </div>
                                    <div class="text-end">
                                        <div>Qty: @h.Quantity</div>
                                        <div class="small text-muted">Avg: @h.AvgCost</div>
                                    </div>
                                </li>
                            }
                        </ul>
                    }
                </div>

                <div class="card-footer bg-white">
                    <a asp-controller="Stock" asp-action="AddStock" class="btn btn-primary w-100">
                        Buy / Sell
                    </a>
                </div>
            </div>
        </div>

        <!-- Right: Profit-over-time chart -->
        <div class="col-lg-7 col-md-6">
            <div class="card shadow-sm">
                <div class="card-header">
                    <strong>Realized Profit Over Time</strong>
                </div>
                <div class="card-body" style="height: 360px;">
                    <canvas id="profitChart"></canvas>
                    @if ((Model.ProfitLabels?.Count ?? 0) == 0)
                    {
                        <div class="text-muted mt-2">
                            No trades yet — the chart appears once you log buys/sells.
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        (function () {
            const labels = @Html.Raw(labelsJson);
            const values = @Html.Raw(valuesJson);

            if (!labels || !labels.length || !values || !values.length) return;

            const ctx = document.getElementById('profitChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Cumulative Realized P&L',
                        data: values,
                        tension: 0.25,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: 'Time' } },
                        y: { title: { display: true, text: 'Profit' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        })();
    </script>
}
